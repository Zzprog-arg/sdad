<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PanelReseller — Admin</title>
<style>
:root{--bg:#0b1220;--card:#0f1724;--muted:#94a3b8;--accent:#22c55e;--danger:#ff6b6b;--glass:rgba(255,255,255,0.03)}
body{margin:0;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;background:linear-gradient(180deg,#071026 0%,#081624 100%);color:#e6eef8}
.header{display:flex;align-items:center;justify-content:space-between;padding:18px 24px;border-bottom:1px solid rgba(255,255,255,0.03);gap:12px}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:44px;height:44px;background:linear-gradient(135deg,#0ea5a4,#7c3aed);border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;color:white}
.title{font-size:18px;font-weight:700}
.sub{color:var(--muted);font-size:13px}
.container{padding:20px;display:grid;grid-template-columns:320px 1fr;gap:18px}
.card{background:var(--card);padding:16px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.02)}
.sidebar .section{margin-bottom:12px}
.input,select,button,textarea{font-size:14px;padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:inherit;width:100%;box-sizing:border-box}
.row{display:flex;gap:8px;align-items:center}
.btn{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:8px;border:0;background:linear-gradient(90deg,#10b981,#22c55e);color:white;cursor:pointer}
.btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
.table{width:100%;border-collapse:collapse;font-size:14px}
.table th{ text-align:left;padding:10px 8px;color:var(--muted);font-size:12px;background:transparent;border-bottom:1px solid rgba(255,255,255,0.02)}
.table td{padding:10px 8px;border-bottom:1px dashed rgba(255,255,255,0.02)}
.actions button{margin-right:6px}
.small{font-size:12px;color:var(--muted)}
.toast{position:fixed;right:20px;bottom:20px;padding:12px 16px;border-radius:8px;background:rgba(0,0,0,0.6);color:white;box-shadow:0 8px 22px rgba(2,6,23,0.6)}
.linkbtn{background:transparent;border:1px solid rgba(255,255,255,0.05);padding:6px 8px;border-radius:6px;cursor:pointer}
.copyarea{display:flex;gap:8px;align-items:center}
.modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,6,23,0.6);z-index:40}
.modal .card{width:720px;max-width:95%}
.kv{display:flex;gap:6px;align-items:center}
.kv b{min-width:110px;color:var(--muted);font-weight:600}
</style>
</head>
<body>
<div class="header">
  <div class="brand">
    <div class="logo">PR</div>
    <div>
      <div class="title" id="panelTitle">PanelReseller</div>
      <div class="sub" id="panelSub">Administración — cuentas, listas y vencimientos</div>
    </div>
  </div>
  <div id="topActions" class="row">
    <div id="loggedInfo" class="small"></div>
    <button id="logoutBtn" class="btn secondary" style="display:none">Cerrar sesión</button>
  </div>
</div>

<div class="container">
  <div class="sidebar">
    <div class="card section">
      <h3 style="margin:0 0 8px 0">Crear cuenta</h3>
      <div class="kv"><b>Usuario</b><input id="newUser" class="input" placeholder="usuario"></div>
      <div class="kv" style="margin-top:8px"><b>Contraseña</b><input id="newPass" class="input" placeholder="password"></div>
      <div style="margin-top:8px"><label class="small">Plan (días)</label>
        <select id="newDays" class="input">
          <option value="30">1 Mes (30 días)</option>
          <option value="60">2 Meses (60 días)</option>
          <option value="90">3 Meses (90 días)</option>
          <option value="7">Demo 1 Semana (7 días)</option>
          <option value="0">Sin vencimiento</option>
        </select>
      </div>
      <div style="margin-top:8px">
        <label class="small">Listas (elige o deja todas)</label>
        <select id="listsSelect" multiple class="input" style="height:110px;overflow:auto"></select>
        <div class="small" style="margin-top:6px">Seleccioná las listas que quieras asignar a la cuenta. Si no hay selección, se asignan todas.</div>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px">
        <button id="createBtn" class="btn">Crear cuenta</button>
        <button id="refreshBtn" class="btn secondary">Refrescar</button>
      </div>
      <div id="createResult" style="margin-top:8px"></div>
    </div>

    <div class="card section">
      <h3 style="margin:0 0 8px 0">Estadísticas</h3>
      <div class="small">Cuentas totales: <span id="statTotal">0</span></div>
      <div class="small" style="margin-top:6px">Créditos (admin): <span id="statCredits">-</span></div>
    </div>
  </div>

  <div class="main card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h3 style="margin:0">Cuentas</h3>
      <div><button id="exportCsv" class="btn secondary">Exportar CSV</button></div>
    </div>

    <table class="table" id="accountsTable">
      <thead><tr><th>Usuario</th><th>Contraseña</th><th>Listas</th><th>Creada</th><th>Vence</th><th>Acciones</th></tr></thead>
      <tbody id="accountsBody"></tbody>
    </table>
  </div>
</div>

<!-- view modal -->
<div id="viewModal" style="display:none" class="modal">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 id="viewTitle">Cuenta</h3>
      <button id="closeView" class="btn secondary">Cerrar</button>
    </div>
    <div style="margin-top:10px" id="viewContent"></div>
  </div>
</div>

<div id="toast" style="display:none" class="toast"></div>

<script>
const API = location.origin;
const getCreds = ()=>({ username: localStorage.getItem("adminUser")||"", password: localStorage.getItem("adminPass")||"" });
const setCreds = (u,p)=>{ localStorage.setItem("adminUser", u); localStorage.setItem("adminPass", p); updateAuthUI(); };
function updateAuthUI(){
  const creds = getCreds();
  const logged = creds.username ? `${creds.username}` : null;
  document.getElementById("loggedInfo").textContent = logged ? `${creds.username} (${creds.password ? 'Authed' : ''})` : "";
  document.getElementById("logoutBtn").style.display = logged ? "inline-flex" : "none";
  if(!logged){
    // show quick login prompt
    const u = prompt("Usuario admin:");
    if(!u) return;
    const p = prompt("Contraseña:");
    if(!p) return;
    setCreds(u,p);
    init(); // try to load
  }
}

async function apiGet(path, qs = {}){
  const creds = getCreds();
  const qp = new URLSearchParams(Object.assign({}, qs, creds.username ? { username: creds.username, password: creds.password } : {}));
  const res = await fetch(`${API}${path}?${qp.toString()}`);
  if(res.status === 401) { throw new Error("Unauthorized"); }
  return res.json();
}
// POST will attach admin creds as query params (so server can authenticate)
async function apiPost(path, body = {}){
  const creds = getCreds();
  const qp = new URLSearchParams(creds.username ? { username: creds.username, password: creds.password } : {});
  const url = `${API}${path}?${qp.toString()}`;
  const res = await fetch(url, {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify(body)
  });
  if(res.status === 401) throw new Error("Unauthorized");
  return res.json();
}

function showToast(text, ok=true){
  const t = document.getElementById("toast");
  t.style.display = "block";
  t.style.background = ok ? "linear-gradient(90deg,#2dd4bf,#16a34a)" : "linear-gradient(90deg,#ff7b7b,#ff5252)";
  t.textContent = text;
  setTimeout(()=>{ t.style.display="none"; }, 3000);
}

async function loadLists(){
  try{
    const data = await apiGet("/admin/available_lists").catch(()=>({ lists: [] }));
    const sel = document.getElementById("listsSelect");
    sel.innerHTML = "";
    for(const l of (data.lists||[])){
      const opt = document.createElement("option");
      opt.value = l; opt.textContent = l;
      sel.appendChild(opt);
    }
  }catch(e){ console.error(e); }
}

async function loadAccounts(){
  try{
    const data = await apiGet("/admin/list_accounts");
    const tbody = document.getElementById("accountsBody");
    tbody.innerHTML = "";
    const accounts = data.accounts || [];
    document.getElementById("statTotal").textContent = accounts.length;
    for(const acc of accounts){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${acc.username}</td>
        <td>${acc.password}</td>
        <td>${(acc.lists||[]).join(", ")}</td>
        <td class="small">${acc.createdAt||""}</td>
        <td class="small">${acc.expiresAt||"---"}</td>
        <td class="actions small">
          <button class="linkbtn" data-user="${acc.username}" data-pass="${acc.password}" onclick="viewAccount('${acc.username}','${acc.password}')">Ver</button>
          <button class="linkbtn" onclick="copyLinks('${acc.username}','${acc.password}')">Copiar links</button>
          <button class="linkbtn" onclick="renewAccountPrompt('${acc.username}')">Renovar</button>
          <button class="linkbtn" onclick="deleteAccount('${acc.username}')">Borrar</button>
        </td>
      `;
      tbody.appendChild(tr);
    }
  }catch(e){ console.error(e); showToast("Error cargando cuentas", false); }
}

function copyToClipboard(text){
  navigator.clipboard.writeText(text).then(()=> showToast("Copiado al portapapeles")).catch(()=> showToast("Fallo al copiar", false));
}

function generateLinks(user, pass){
  const base = location.origin;
  const p1 = `${base}/playlist/${encodeURIComponent(user)}/${encodeURIComponent(pass)}.m3u`;
  const p2 = `${base}/get.php.m3u?username=${encodeURIComponent(user)}&password=${encodeURIComponent(pass)}`;
  const p3 = `${base}/get.php?username=${encodeURIComponent(user)}&password=${encodeURIComponent(pass)}`;
  return { p1,p2,p3 };
}

function copyLinks(user, pass){
  const {p1,p2,p3} = generateLinks(user,pass);
  copyToClipboard(`${p1}\n${p2}\n${p3}`);
}

function viewAccount(user, pass){
  const modal = document.getElementById("viewModal");
  const content = document.getElementById("viewContent");
  const {p1,p2,p3} = generateLinks(user,pass);
  content.innerHTML = `
    <div class="kv"><b>Usuario</b><div>${user}</div></div>
    <div class="kv" style="margin-top:8px"><b>Contraseña</b><div>${pass}</div></div>
    <div style="margin-top:10px">
      <div class="small">Enlaces disponibles:</div>
      <div style="margin-top:6px" class="copyarea">
        <input class="input" readonly value="${p1}"><button class="linkbtn" onclick="copySingle('${p1}')">Copiar</button>
      </div>
      <div style="margin-top:6px" class="copyarea">
        <input class="input" readonly value="${p2}"><button class="linkbtn" onclick="copySingle('${p2}')">Copiar</button>
      </div>
      <div style="margin-top:6px" class="copyarea">
        <input class="input" readonly value="${p3}"><button class="linkbtn" onclick="copySingle('${p3}')">Copiar</button>
      </div>
    </div>
  `;
  modal.style.display = "flex";
}

function copySingle(text){ copyToClipboard(text); }

document.getElementById("closeView").addEventListener("click", ()=>{
  document.getElementById("viewModal").style.display = "none";
});

async function createAccount(){
  const user = document.getElementById("newUser").value.trim();
  const pass = document.getElementById("newPass").value.trim();
  const days = Number(document.getElementById("newDays").value || 0);
  const lists = Array.from(document.getElementById("listsSelect").selectedOptions).map(o=>o.value);
  if(!user || !pass){ showToast("Usuario/contraseña requeridos", false); return; }
  try{
    const body = { username: user, password: pass, days: days>0?days:0, lists };
    const r = await apiPost("/admin/add_account", body);
    if(r && r.ok){
      showToast("Cuenta creada correctamente");
      document.getElementById("newUser").value = "";
      document.getElementById("newPass").value = "";
      await loadAccounts();
    }else{
      showToast("Error: " + (r && r.error? r.error : "desconocido"), false);
    }
  }catch(e){ console.error(e); showToast("Error creando cuenta", false); }
}

async function deleteAccount(user){
  if(!confirm("Borrar cuenta " + user + " ?")) return;
  try{
    const r = await apiPost("/admin/delete_account", { username: user });
    if(r && r.ok){ showToast("Cuenta borrada"); await loadAccounts(); } else showToast("Error borrando", false);
  }catch(e){ console.error(e); showToast("Error borrando", false); }
}

async function renewAccountPrompt(user){
  const days = prompt("¿Cuántos días añadir? (ej: 30)");
  if(!days) return;
  const n = Number(days);
  if(Number.isNaN(n) || n<=0){ showToast("Días inválidos", false); return; }
  try{
    const r = await apiPost("/admin/set_account_expiry", { username: user, days: n });
    if(r && r.ok){ showToast("Cuenta renovada"); await loadAccounts(); } else showToast("Error renovando", false);
  }catch(e){ console.error(e); showToast("Error renovando", false); }
}

document.getElementById("createBtn").addEventListener("click", createAccount);
document.getElementById("refreshBtn").addEventListener("click", ()=>{ loadLists(); loadAccounts(); });

document.getElementById("logoutBtn").addEventListener("click", ()=>{ localStorage.removeItem("adminUser"); localStorage.removeItem("adminPass"); location.reload(); });

document.getElementById("exportCsv").addEventListener("click", async ()=>{
  try{
    const data = await apiGet("/admin/list_accounts");
    const rows = [["username","password","lists","createdAt","expiresAt"]];
    for(const a of (data.accounts||[])) rows.push([a.username,a.password,(a.lists||[]).join("|"),a.createdAt||"",(a.expiresAt||"")]);
    const csv = rows.map(r=>r.map(c=>`"${(c||"").toString().replace(/"/g,'""')}"`).join(",")).join("\n");
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href = url; a.download = "accounts.csv"; a.click(); URL.revokeObjectURL(url);
  }catch(e){ showToast("Error exportando", false); }
});

async function init(){
  try{
    updateAuthUI();
    await loadLists();
    await loadAccounts();
    // try to fetch /admin/me to display credits (optional)
    const creds = getCreds();
    if(creds.username){
      try{
        const res = await fetch(`${API}/admin/me?username=${encodeURIComponent(creds.username)}&password=${encodeURIComponent(creds.password)}`);
        if(res.ok){
          const j = await res.json();
          document.getElementById("statCredits").textContent = j.me ? j.me.credits : "-";
          document.getElementById("panelSub").textContent = `${j.me ? j.me.username : ''} — ${(j.me && j.me.isMaster) ? 'SuperAdmin' : 'Reseller'}`;
        }
      }catch(e){}
    }
  }catch(e){ console.error(e); }
}

window.addEventListener("load", ()=>{
  // start UI
  updateAuthUI();
  init();
});
</script>
</body>
</html>
