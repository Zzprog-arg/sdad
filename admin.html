<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PanelReseller — Admin Xtream-lite</title>
  <style>
    /* same styles as previous versions (trimmed for brevity) */
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    :root{
      --bg:#071126;--card:#0b1220;--muted:#9aa8bf;--accent:#6c5ce7;--accent-2:#06b6d4;
      --success:#16a34a;--warn:#f59e0b;--danger:#ef4444;--glass: rgba(255,255,255,0.03);
      --radius:12px;--text:#e6eef8;--glass-border: rgba(255,255,255,0.04);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    body{background:linear-gradient(180deg,#031029 0%, #071226 100%);color:var(--text);padding:20px}
    .app{max-width:1200px;margin:0 auto}
    header.app-header{display:flex;align-items:center;gap:18px;margin-bottom:20px}
    .logo{display:flex;align-items:center;gap:12px}
    .logo .badge{width:64px;height:64px;border-radius:14px;background:linear-gradient(135deg,var(--accent),#7c3aed);display:flex;align-items:center;justify-content:center}
    .logo h1{margin:0;font-size:20px}
    .logo p{margin:0;font-size:12px;color:var(--muted)}
    .actions{margin-left:auto;display:flex;gap:10px;align-items:center}
    .btn{background:var(--accent);border:0;padding:10px 12px;border-radius:12px;color:white;font-weight:600;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid var(--glass-border);color:var(--text)}
    .panel{display:grid;grid-template-columns:360px 1fr;gap:24px;align-items:start}
    .sidebar{background: linear-gradient(180deg,var(--card), rgba(11,19,32,0.85));border-radius:var(--radius);padding:20px;border:1px solid var(--glass-border);position:sticky;top:20px;height: calc(100vh - 40px);overflow:auto;}
    .small{font-size:13px;color:var(--muted)}
    .chip{display:inline-block;padding:6px 10px;border-radius:999px;background:var(--glass);font-size:13px;color:var(--muted);border:1px solid var(--glass-border)}
    .main{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:18px;border-radius:var(--radius);border:1px solid var(--glass-border);overflow:auto}
    table.accounts{ width:100%; border-collapse:separate; border-spacing:0 14px; }
    table.accounts thead th{ font-size:13px; color:var(--muted); text-align:left; padding:12px 16px; }
    table.accounts tbody td{ padding:12px 16px; vertical-align:middle; white-space:nowrap; max-width:220px; overflow:hidden; text-overflow:ellipsis; }
    .username{font-weight:700; font-size:15px}
    .pass{ font-family: ui-monospace; background:rgba(255,255,255,0.02); padding:8px 12px; border-radius:10px; display:inline-block; margin-right:10px; letter-spacing:2px }
    .date-small{ display:block; font-size:12px; color:var(--muted); margin-top:6px; }
    .badge-status{padding:6px 8px;border-radius:999px;font-weight:700;font-size:12px}
    .actions-col{ white-space:nowrap; display:flex; gap:8px; align-items:center; justify-content:flex-end; min-width:120px; }
    .toast{position:fixed;right:20px;bottom:20px;background:#041226;padding:12px 16px;border-radius:12px;border:1px solid var(--glass-border);box-shadow:0 8px 30px rgba(6,11,23,0.6);opacity:0;transition:opacity .18s}
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.6);display:flex;align-items:center;justify-content:center;z-index:9999}
    .modal{background:linear-gradient(180deg,#0b1220,#07101a);padding:20px;border-radius:14px;width:560px;border:1px solid var(--glass-border)}
  </style>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div class="logo">
        <div class="badge" aria-hidden></div>
        <div>
          <h1>PanelReseller</h1>
          <p id="subtitle" class="small">Administración — cuentas, listas y vencimientos</p>
        </div>
      </div>
      <div class="actions">
        <button id="btnAdd" class="btn">+ Añadir cuenta</button>
        <button id="btnRefresh" class="btn ghost">Actualizar</button>
        <button id="btnLogout" class="btn ghost">Cerrar sesión</button>
      </div>
    </header>

    <div class="panel">
      <aside class="sidebar">
        <div class="side-section">
          <h3>Información</h3>
          <p class="small">Aquí podés crear cuentas, asignarles listas (.m3u) y renovar vencimientos.</p>
        </div>
        <div class="side-section">
          <h3>Stats</h3>
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
            <div class="chip" id="totalCount">Cuentas: —</div>
            <div class="chip" id="creditsCount">Créditos: —</div>
          </div>
        </div>
      </aside>

      <main class="main">
        <div style="overflow:auto;max-height:660px">
          <table class="accounts" id="tblAccounts">
            <thead>
              <tr><th>Usuario</th><th>Pass</th><th>Listas</th><th>Creada</th><th>Vence</th><th>Estado</th><th>Acciones</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </main>
    </div>
  </div>

  <div id="modalRoot" style="display:none"></div>
  <div id="toast" style="display:none" class="toast">Copiado</div>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const byId = id => document.getElementById(id);
      function showToast(text){
        const t = byId('toast');
        t.textContent = text;
        t.style.display = 'block';
        t.style.opacity = '1';
        clearTimeout(showToast._timer);
        showToast._timer = setTimeout(()=>{ t.style.opacity='0'; t.style.display='none'; }, 2200);
      }

      async function fetchJson(url, opts){
        const res = await fetch(url, { credentials: 'same-origin', ...opts });
        const ct = res.headers.get('content-type') || '';
        if(ct.includes('application/json')) return { ok: res.ok, json: await res.json(), status: res.status };
        return { ok: res.ok, text: await res.text(), status: res.status };
      }

      // simplified loadMe + loadAccounts to demo credits and accounts
      async function loadMe(){
        try{
          const r = await fetchJson('/admin/me');
          if(r.ok && r.json && r.json.me){
            const me = r.json.me;
            const subtitle = byId('subtitle');
            subtitle.textContent = `${me.username} — (${me.isMaster ? 'SuperAdmin':'Reseller'})`;
            byId('creditsCount').textContent = `Créditos: ${me.credits ?? '—'}`;
          }
        }catch(e){ console.warn(e); }
      }
      async function loadAccounts(){
        try{
          const r = await fetchJson('/admin/list_accounts');
          if(!r.ok) return;
          const accounts = r.json.accounts || [];
          byId('totalCount').textContent = `Cuentas: ${accounts.length}`;
          const tbody = document.querySelector('#tblAccounts tbody');
          tbody.innerHTML = accounts.map(a => {
            return `<tr>
              <td>${a.username}</td>
              <td>••••••</td>
              <td>${(a.lists||[]).join(', ')}</td>
              <td>${a.createdAt? new Date(a.createdAt).toLocaleDateString() : ''}</td>
              <td>${a.expiresAt? new Date(a.expiresAt).toLocaleDateString() : ''}</td>
              <td>${a.expiresAt && new Date(a.expiresAt) < new Date() ? 'Vencida':'Activa'}</td>
              <td><button class="btn ghost" onclick="navigator.clipboard.writeText(location.origin + '/get.php?username=${encodeURIComponent(a.username)}&password=${encodeURIComponent(a.password)}').then(()=>alert('Copiado'))">Copiar</button></td>
            </tr>`}).join('');
        }catch(e){ console.warn(e); }
      }

      // Improved logout: use fetch to request /admin/logout and show a friendly message.
      // Direct navigation to /admin/logout causes browser to attempt auth and show chrome-error page.
      byId('btnLogout').onclick = async () => {
        try{
          const r = await fetch('/admin/logout', { credentials: 'same-origin' });
          // most servers will return 401; we intercept it and show a friendly UI instead of letting the browser render chrome-error.
          if(r.status === 401){
            // show modal explaining how to fully logout
            const modal = document.createElement('div'); modal.className='modal';
            modal.innerHTML = `<h3>Sesión cerrada</h3>
              <p class="small">Se ha solicitado cerrar la sesión. Algunos navegadores mantienen las credenciales de Basic Auth en memoria y pueden requerir cerrar la pestaña o el navegador para completar el logout.</p>
              <p class="small">Opciones:</p>
              <ul>
                <li>Cerrar esta pestaña y abrir una nueva.</li>
                <li>Abrir el panel en una ventana incógnita para iniciar sesión con otra cuenta.</li>
                <li>Presionar "Reingresar" para abrir la página de login (podría seguir usando las mismas credenciales hasta que se cierre la sesión del navegador).</li>
              </ul>
              <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
                <button id="btnReLogin" class="btn">Reingresar</button>
                <button id="btnCloseM" class="btn ghost">Cerrar</button>
              </div>`;
            const root = byId('modalRoot'); root.innerHTML = ''; const backdrop = document.createElement('div'); backdrop.className = 'modal-backdrop'; backdrop.appendChild(modal); root.appendChild(backdrop); root.style.display = 'block';
            document.getElementById('btnCloseM').onclick = () => { root.style.display='none'; root.innerHTML=''; };
            document.getElementById('btnReLogin').onclick = () => { root.style.display='none'; root.innerHTML=''; window.location.href = '/admin'; };
          }else{
            // if server returned 200, still show message
            showToast('Logout efectuado');
            // encourage user to reload
            setTimeout(()=>{ window.location.href = '/admin'; }, 600);
          }
        }catch(e){
          console.warn('Logout fetch failed', e);
          alert('Error al cerrar sesión. Podés cerrar la pestaña para completar el logout.');
        }
      };

      // init
      (async ()=>{
        await loadMe();
        await loadAccounts();
      })();

    });
  </script>
</body>
</html>
