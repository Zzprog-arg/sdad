<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PanelReseller — Panel (Planes)</title>
  <style>
    /* Simpler "panel" look: clean, neutral, admin-style */
    :root{
      --bg: #f4f6f8;
      --card: #ffffff;
      --muted: #6b7280;
      --accent: #1f6feb;
      --danger: #dc2626;
      --success: #15803d;
      --border: #e6eef8;
      --radius:8px;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color-scheme: light;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:#0f172a}
    .container{max-width:1100px;margin:26px auto;padding:18px}
    header{display:flex;align-items:center;gap:18px;margin-bottom:18px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:54px;height:54px;border-radius:8px;background:var(--accent);display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
    h1{margin:0;font-size:18px}
    .subtitle{margin:0;color:var(--muted);font-size:13px}

    .actions{margin-left:auto;display:flex;gap:10px}
    .btn{background:var(--accent);color:white;border:0;padding:9px 12px;border-radius:8px;cursor:pointer;font-weight:600}
    .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--muted)}
    .btn.warn{background:var(--danger)}

    .layout{display:grid;grid-template-columns:280px 1fr;gap:18px}
    @media (max-width:900px){ .layout{grid-template-columns:1fr} }

    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 6px 18px rgba(15,23,42,0.03)}
    .card h3{margin:0 0 10px 0;font-size:14px}
    .field{margin-bottom:10px}
    .field label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type="text"], input[type="search"], input[type="number"], select{width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:transparent;color:inherit}

    /* table */
    table{width:100%;border-collapse:collapse}
    thead th{font-size:13px;color:var(--muted);text-align:left;padding:10px;border-bottom:1px solid var(--border)}
    tbody td{padding:12px 8px;border-bottom:1px solid #f1f5f9;vertical-align:middle}
    .username{font-weight:700}
    .small{font-size:12px;color:var(--muted)}

    .chip{display:inline-block;padding:6px 8px;background:#f1f5f9;border-radius:999px;border:1px solid var(--border);font-size:12px;color:var(--muted);margin-right:6px}

    .footer-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

    /* modal simple */
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.35);display:flex;align-items:center;justify-content:center;z-index:9999}
    .modal{width:640px;background:var(--card);border:1px solid var(--border);padding:16px;border-radius:8px}
    .modal h3{margin:0 0 10px 0}
    .modal .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}

    .toast{position:fixed;right:18px;bottom:18px;background:#111827;color:white;padding:10px 14px;border-radius:8px;display:none}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">PR</div>
        <div>
          <h1>PanelReseller</h1>
          <div class="subtitle" id="subtitle">Cuenta — Reseller</div>
        </div>
      </div>

      <div class="actions">
        <button id="btnAdd" class="btn">+ Crear cuenta (Planes)</button>
        <button id="btnSettings" class="btn ghost">Ajustes</button>
        <button id="btnLogout" class="btn ghost">Cerrar sesión</button>
      </div>
    </header>

    <div class="layout">
      <aside class="card">
        <h3>Buscar</h3>
        <div class="field"><input id="q" type="search" placeholder="Buscar usuario..." /></div>

        <h3>Planes disponibles</h3>
        <div id="plansWrap" style="display:flex;flex-direction:column;gap:8px;margin-bottom:10px">
          <!-- plan buttons rendered by JS -->
        </div>
        <div class="small">Todos los planes incluyen <b>todas</b> las listas encontradas automáticamente.</div>

        <h3 style="margin-top:14px">Stats</h3>
        <div style="display:flex;gap:8px;flex-direction:column;margin-top:8px">
          <div class="small">Cuentas: <b id="statTotal">—</b></div>
          <div class="small">Activas: <b id="statActive">—</b></div>
          <div class="small">Por vencer: <b id="statSoon">—</b></div>
          <div class="small">Vencidas: <b id="statExp">—</b></div>
          <div class="small">Créditos: <b id="statCredits">—</b></div>
        </div>
      </aside>

      <main>
        <div class="card" style="margin-bottom:12px;display:flex;justify-content:space-between;align-items:center">
          <div>
            <h3 style="margin:0">Lista de cuentas</h3>
            <div class="small">Gestioná usuarios, vencimientos y planes</div>
          </div>
          <div style="display:flex;gap:8px">
            <button id="btnExport" class="btn ghost">Exportar CSV</button>
            <button id="btnRefresh" class="btn ghost">Actualizar</button>
          </div>
        </div>

        <div class="card">
          <table id="tbl">
            <thead>
              <tr><th>Usuario</th><th>Contraseña</th><th>Listas</th><th>Creada</th><th>Vence</th><th>Plan</th><th style="text-align:right">Acciones</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </main>
    </div>
  </div>

  <div id="modalRoot" style="display:none"></div>
  <div id="toast" class="toast">...</div>

  <script>
    (function(){
      const byId = id => document.getElementById(id);
      const toast = byId('toast');
      function showToast(msg){ toast.textContent = msg; toast.style.display='block'; clearTimeout(showToast._t); showToast._t = setTimeout(()=> toast.style.display='none',2200); }

      async function fetchJson(url, opts){
        const res = await fetch(url, { credentials: 'same-origin', ...opts });
        const ct = res.headers.get('content-type') || '';
        if(ct.includes('application/json')) return { ok: res.ok, json: await res.json(), status: res.status };
        return { ok: res.ok, text: await res.text(), status: res.status };
      }

      // Plans definition: label, days (or hours), costCredits, unit
      const PLANS = [
        { id:'demo_1h', label:'1 HORA (Demo)', unit:'hour', amount:1, days:0, hours:1, cost:0 },
        { id:'1m', label:'1 MES', unit:'month', amount:1, days:30, cost:1 },
        { id:'2m', label:'2 MESES', unit:'month', amount:2, days:60, cost:2 },
        { id:'3m', label:'3 MESES', unit:'month', amount:3, days:90, cost:3 },
        { id:'6m', label:'6 MESES', unit:'month', amount:6, days:180, cost:6 },
      ];

      let ACCOUNTS = [], LISTS = [], ME = null;

      const tbody = document.querySelector('#tbl tbody');

      function formatDate(s){ return s ? new Date(s).toLocaleString() : '-'; }
      const daysLeft = s => !s ? null : Math.ceil((new Date(s) - Date.now())/(24*60*60*1000));

      // render plans UI in sidebar
      function renderPlans(){
        const wrap = byId('plansWrap');
        wrap.innerHTML = '';
        PLANS.forEach(p => {
          const el = document.createElement('button');
          el.className = 'btn ghost';
          el.style.textAlign = 'left';
          el.innerHTML = `<div style="display:flex;justify-content:space-between;width:100%"><div><strong>${p.label}</strong><div class="small">Costo: ${p.cost} crédito(s)</div></div><div class="small">${p.unit==='hour' ? p.hours+'h' : p.amount+' mes(es)'}</div></div>`;
          el.onclick = () => openCreateForPlan(p);
          wrap.appendChild(el);
        });
      }

      // load meta
      async function loadMe(){
        const r = await fetchJson('/admin/me');
        if(r.ok && r.json && r.json.me){
          ME = r.json.me;
          byId('subtitle').textContent = `${ME.username} — ${ME.isMaster ? 'SuperAdmin' : 'Reseller'}`;
          byId('statCredits').textContent = ME.credits ?? '—';
        }
      }
      async function loadLists(){
        const r = await fetchJson('/admin/available_lists');
        LISTS = (r.ok && r.json && Array.isArray(r.json.lists)) ? r.json.lists : [];
      }
      async function loadAccounts(){
        const r = await fetchJson('/admin/list_accounts');
        if(!r.ok){ alert('No autorizado o error cargando cuentas'); return; }
        ACCOUNTS = r.json.accounts || [];
        renderAccounts();
      }

      function renderAccounts(){
        tbody.innerHTML = '';
        ACCOUNTS.forEach(acc => {
          const dl = daysLeft(acc.expiresAt);
          const planLabel = acc.planLabel || '-';
          const listsHtml = (acc.lists||[]).map(l => `<span class="chip">${l}</span>`).join(' ');
          const tr = document.createElement('tr');
          tr.innerHTML = `<td class="username">${acc.username}</td>
            <td>••••••</td>
            <td>${listsHtml}</td>
            <td class="small">${formatDate(acc.createdAt)}</td>
            <td class="small">${formatDate(acc.expiresAt)}</td>
            <td class="small">${planLabel}</td>
            <td style="text-align:right">
              <button class="btn ghost" data-action="view">Ver</button>
              <button class="btn" data-action="copy">Copiar</button>
              <button class="btn ghost" data-action="renew">Renovar</button>
              <button class="btn warn" data-action="del">Borrar</button>
            </td>`;
          tr.querySelector('[data-action="view"]').onclick = () => openViewModal(acc);
          tr.querySelector('[data-action="copy"]').onclick = async () => {
            const link = `${location.origin}/get.php?username=${encodeURIComponent(acc.username)}&password=${encodeURIComponent(acc.password)}`;
            try{ await navigator.clipboard.writeText(link); showToast('Enlace copiado'); }catch(e){ alert(link); }
          };
          tr.querySelector('[data-action="renew"]').onclick = async () => {
            const months = Number(prompt('Cuántos meses añadir?', '1') || 0);
            if(!months) return;
            const res = await fetchJson('/admin/set_account_expiry', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ username: acc.username, days: months*30 }) });
            if(res.ok && res.json && res.json.ok){ showToast('Cuenta renovada'); await loadAccounts(); } else alert('Error renovando');
          };
          tr.querySelector('[data-action="del"]').onclick = async () => {
            if(!confirm('Borrar cuenta ' + acc.username + '?')) return;
            const res = await fetchJson('/admin/delete_account', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ username: acc.username }) });
            if(res.ok && res.json && res.json.ok){ showToast('Cuenta borrada'); await loadAccounts(); } else alert('Error borrando');
          };
          tbody.appendChild(tr);
        });

        // stats
        const total = ACCOUNTS.length;
        let active=0, soon=0, exp=0;
        ACCOUNTS.forEach(a => {
          const dl = daysLeft(a.expiresAt);
          if(dl === null) active++;
          else if(dl <= 0) exp++;
          else if(dl <= 7) soon++;
          else active++;
        });
        byId('statTotal').textContent = total;
        byId('statActive').textContent = active;
        byId('statSoon').textContent = soon;
        byId('statExp').textContent = exp;
      }

      // Open create modal for given plan
      function openCreateForPlan(plan){
        const modal = document.createElement('div'); modal.className='modal';
        modal.innerHTML = `<h3>Crear cuenta — ${plan.label}</h3>
          <div style="margin-top:10px">
            <div class="field"><label>Usuario</label><input id="c_user" type="text" /></div>
            <div class="field"><label>Contraseña</label><input id="c_pass" type="text" /></div>
            <div class="field"><label>Plan</label><input type="text" value="${plan.label}" disabled /></div>
            <div class="field small">Lista(s) incluidas: todas las listas detectadas (${LISTS.length})</div>
            <div class="small">Costo en créditos: <b id="planCost">${plan.cost}</b></div>
            <div class="footer-actions"><button class="btn ghost" id="c_cancel">Cancelar</button><button class="btn" id="c_create">Crear cuenta</button></div>
          </div>`;
        const root = byId('modalRoot'); root.innerHTML = ''; const back = document.createElement('div'); back.className='modal-backdrop'; back.appendChild(modal); root.appendChild(back); root.style.display='block';
        back.onclick = (ev) => { if(ev.target === back) { root.style.display='none'; root.innerHTML=''; } };
        modal.querySelector('#c_cancel').onclick = () => { root.style.display='none'; root.innerHTML=''; };
        modal.querySelector('#c_create').onclick = async () => {
          const username = modal.querySelector('#c_user').value.trim();
          const password = modal.querySelector('#c_pass').value.trim();
          if(!username || !password){ alert('Usuario y contraseña requeridos'); return; }
          // check credits for resellers (superadmin bypass)
          const cost = plan.cost || 0;
          if(!ME) { alert('No autorizado'); return; }
          if(!ME.isMaster && cost > 0){
            const credits = Number(ME.credits || 0);
            if(credits < cost){ alert('No tenés créditos suficientes.'); return; }
          }
          // prepare payload: lists = all lists found
          const payload = { username, password };
          if(plan.unit === 'hour' && plan.hours){
            // set expiresAt to now + hours
            const expires = new Date(Date.now() + plan.hours*60*60*1000).toISOString();
            payload.expiresAt = expires;
          } else if(plan.days){
            payload.days = plan.days;
          }
          // include all lists
          payload.lists = LISTS.slice();

          // call add_account
          const res = await fetchJson('/admin/add_account', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          if(!(res.ok && res.json && res.json.ok)){ alert('Error creando cuenta: ' + (res.json?.error || res.text || 'unknown')); return; }
          // If creation success and cost > 0 and user is reseller, deduct credits via set_admin_credits
          if(!ME.isMaster && cost > 0){
            const newCredits = Number(ME.credits || 0) - cost;
            const r2 = await fetchJson('/admin/set_admin_credits', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ username: ME.username, credits: newCredits }) });
            if(r2.ok && r2.json && r2.json.ok){
              ME.credits = newCredits;
              byId('statCredits').textContent = ME.credits;
            } else {
              console.warn('No se pudo actualizar créditos en backend.'); // still ok
            }
          }
          showToast('Cuenta creada');
          root.style.display='none'; root.innerHTML='';
          await loadAccounts();
        };
      }

      // view modal
      function openViewModal(acc){
        const modal = document.createElement('div'); modal.className='modal';
        modal.innerHTML = `<h3>Cuenta — ${acc.username}</h3>
          <div style="margin-top:8px">
            <div class="small"><b>Usuario:</b> ${acc.username}</div>
            <div class="small"><b>Contraseña:</b> ${acc.password}</div>
            <div class="small"><b>Listas:</b> ${(acc.lists||[]).join(', ')}</div>
            <div class="small"><b>Creada:</b> ${formatDate(acc.createdAt)}</div>
            <div class="small"><b>Vence:</b> ${formatDate(acc.expiresAt)}</div>
            <div class="footer-actions"><button class="btn ghost" id="v_close">Cerrar</button></div>
          </div>`;
        const root = byId('modalRoot'); root.innerHTML=''; const back = document.createElement('div'); back.className='modal-backdrop'; back.appendChild(modal); root.appendChild(back); root.style.display='block';
        modal.querySelector('#v_close').onclick = () => { root.style.display='none'; root.innerHTML=''; };
      }

      // Wire UI events
      byId('btnAdd').onclick = () => openCreateForPlan(PLANS[1]); // default to 1 month
      byId('btnRefresh').onclick = async () => { await loadLists(); await loadAccounts(); showToast('Actualizado'); };
      byId('btnExport').onclick = async () => {
        const rows = [['username','password','createdAt','expiresAt','lists']];
        ACCOUNTS.forEach(a => rows.push([a.username,a.password,a.createdAt,a.expiresAt,(a.lists||[]).join(';')]));
        const csv = rows.map(r => r.map(c => '"' + String(c||'').replace(/"/g,'""') + '"').join(',')).join('\n');
        const blob = new Blob([csv],{type:'text/csv'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download='accounts.csv'; a.click(); URL.revokeObjectURL(url);
        showToast('CSV generado');
      };
      byId('btnLogout').onclick = async () => {
        // same strategy: call /admin/logout via fetch to avoid browser's auth dialog
        try{
          const r = await fetch('/admin/logout', { credentials: 'same-origin' });
          if(r.status === 401){ alert('Logout solicitado — cerrá la pestaña si el navegador sigue recordando las credenciales.'); }
          else showToast('Logout');
        }catch(e){ console.warn(e); alert('Error logout'); }
      };

      // init
      (async ()=>{
        renderPlans();
        await loadMe();
        await loadLists();
        await loadAccounts();
      })();

      // expose for debug
      window.__pr = { PLANS, loadAccounts, loadLists, loadMe };
    })();
  </script>
</body>
</html>
